const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./CXxwv03e.js","./C4nQMaHf.js","./CKiwDKMb.js","./entry.DTm9GmC1.css","./zK5C3jIS.js","./C84EnH34.js"])))=>i.map(i=>d[i]);
import{_ as ne,p as re,r as u,g as ie,h as V,c as o,o as l,a as t,i as W,j as v,b as M,t as i,w as Q,T as q,y as I,I as L,F as H,m as F,d as S,J as ue,z as J,K as de,x as ce,n as ve,l as pe}from"./CKiwDKMb.js";import{_ as fe}from"./B28r5yU-.js";import{C as me}from"./C84EnH34.js";import{u as ge}from"./C4nQMaHf.js";const he={class:"outbound-container"},be={class:"outbound-card"},ye={key:0,class:"debug-box"},we={key:1,class:"loading-state"},ke={key:2,class:"cafe-selection"},_e={class:"select-wrapper"},Ce=["disabled"],Se=["value"],xe=["disabled"],De={key:0,class:"cafe-count"},Ne={key:3,class:"form"},Ae=["disabled"],Ie={key:0},Te={key:1},Pe={key:2},Re={id:"qr-reader",style:{width:"100%","max-width":"400px",margin:"0 auto 20px"}},Me={key:2,class:"divider"},Qe={class:"input-group"},Be={class:"input-wrapper"},Ee=["onKeyup","disabled"],$e={class:"input-group"},Oe={class:"input-wrapper"},Ve=["disabled"],We={class:"input-group offset-group"},qe={class:"select-wrapper"},Le=["disabled"],He=["disabled"],Fe={key:0},Je={key:1},Ue={key:4,class:"empty-state"},je={key:0,class:"error-text"},Ke={key:0,class:"result-box"},ze={class:"result-header"},Ge={class:"result-cafe"},Xe={class:"result-grid"},Ye={class:"result-item"},Ze={class:"item-value"},et={class:"result-item"},tt={class:"item-value"},at={class:"result-item"},st={class:"item-value"},ot={class:"result-item"},lt={class:"item-value"},nt={class:"result-item"},rt={class:"item-value"},it={class:"result-item"},ut={class:"item-value"},dt={class:"result-item"},ct={class:"item-value"},vt={key:5,class:"summary"},pt={class:"summary-header"},ft={class:"summary-count"},mt={class:"summary-list"},gt={class:"summary-cafe"},ht={class:"summary-details"},bt={class:"footer"},yt={__name:"outbound",setup(wt){console.log("🚚 Outbound page is loading!");const{user:U}=ge(),j=re().public.firstAdminEmail||"",_=u(!1),y=u(!1),f=u(!1),m=u(!1),K=u(!1),C=u(!1),h=u(""),g=u(null),x=u(0),D=u(null),p=u(null),w=u([]),k=u(!1),N=u(null),c=u([]),d=u("");let A=null,T=null;ie(async()=>{console.log("🚚 Outbound page mounted"),console.log("👤 User:",U.value),console.log("📧 Admin email:",j),console.log("✅ Admin access granted (auth temporarily disabled)"),await B(),await X(),_.value||await G(),se()});async function B(){C.value=!0;try{console.log("🔄 Fetching sheets list from API...");const a=await fetch("/api/sheets/list");if(!a.ok){const r=await a.text();throw console.error("❌ API returned error:",a.status,r),new Error(`API Error: ${a.status} - ${r}`)}const e=await a.json();console.log("📦 API Response:",e),e.debug&&(N.value=e.debug,console.log("🐛 Debug info:",e.debug)),c.value=e.sheets||[],console.log("☕ Loaded cafes from sheets:",c.value),console.log("📊 Number of cafes:",c.value.length),c.value.length===0?(n("هیچ کافه‌ای در سیستم یافت نشد. لطفاً Google Sheet را بررسی کنید.","warning"),console.warn("⚠️ No cafes found in the response")):console.log("✅ Cafes loaded successfully:",c.value.map(r=>r.name).join(", "))}catch(a){console.error("❌ Error loading cafes:",a),n(`خطا در بارگذاری لیست کافه‌ها: ${a.message}`,"error"),c.value=[],N.value={error:a.message,stack:a.stack}}finally{C.value=!1}}async function z(){d.value="",N.value=null,await B(),c.value.length>0&&n(`لیست کافه‌ها بازخوانی شد (${c.value.length} کافه)`,"success")}async function G(){try{const{Html5Qrcode:a}=await V(async()=>{const{Html5Qrcode:e}=await import("./CXxwv03e.js");return{Html5Qrcode:e}},__vite__mapDeps([0,1,2,3]),import.meta.url);T=a,console.log("✅ Html5Qrcode library loaded")}catch(a){if(console.error("Error loading Html5Qrcode:",a),typeof window<"u"&&!window.Html5Qrcode){const e=document.createElement("script");e.src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js",e.onload=()=>{T=window.Html5Qrcode,console.log("✅ Html5Qrcode loaded from CDN")},document.head.appendChild(e)}}}async function X(){me.isNativePlatform()?(console.log("📱 Native platform detected"),_.value=!0,await Y()):(console.log("🌐 Web platform detected"),_.value=!1,await Z())}async function Y(){try{A=(await V(()=>import("./zK5C3jIS.js"),__vite__mapDeps([4,2,3,5]),import.meta.url)).BarcodeScanner;const{supported:e}=await A.isSupported();e&&(y.value=!0,console.log("✅ Capacitor camera available"))}catch(a){console.error("خطا در بارگذاری BarcodeScanner:",a),y.value=!1}}async function Z(){try{navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?(y.value=!0,console.log("✅ Web camera API available")):(y.value=!1,console.log("❌ Camera API not supported"))}catch(a){console.error("Error checking web camera:",a),y.value=!1}}async function E(){if(!T){n("کتابخانه اسکنر در حال بارگذاری است...","info"),setTimeout(()=>E(),1e3);return}try{k.value=!0,f.value=!0,await ve(),setTimeout(async()=>{try{const a=new T("qr-reader"),e={fps:10,qrbox:{width:250,height:250},aspectRatio:1,rememberLastUsedCamera:!0,supportedScanTypes:[0]};await a.start({facingMode:"environment"},e,async r=>{console.log("QR Code detected:",r),h.value=r,await P(a),n("کد QR با موفقیت اسکن شد","success")},r=>{}).catch(r=>{console.error("Error starting scanner:",r),n("خطا در راه‌اندازی دوربین","error"),P(a)}),window.currentScanner=a}catch(a){console.error("Scanner initialization error:",a),n("خطا در راه‌اندازی اسکنر","error"),f.value=!1,k.value=!1}},100)}catch(a){console.error("Scanner error:",a),n("خطا در اسکن QR","error"),f.value=!1,k.value=!1}}async function P(a=null){try{const e=a||window.currentScanner;e&&(await e.stop(),e.clear(),window.currentScanner=null)}catch(e){console.error("Error stopping scanner:",e)}finally{f.value=!1,k.value=!1}}async function ee(){if(!d.value){n("لطفاً ابتدا کافه را انتخاب کنید","error");return}if(!_.value){k.value?await P():await E();return}if(!(!A||f.value))try{f.value=!0;const{camera:a}=await A.requestPermissions();if(a!=="granted"&&a!=="limited"){n("دسترسی به دوربین رد شد","error");return}const e=await A.scan({formats:[]});if(e?.barcodes?.length>0){const r=e.barcodes[0].rawValue||e.barcodes[0].displayValue;h.value=r,n("کد QR با موفقیت اسکن شد","success")}else n("کدی شناسایی نشد","info")}catch(a){n(`خطا در اسکن: ${a.message}`,"error")}finally{f.value=!1}}async function $(){const a=h.value.trim();if(a){if(!d.value){n("لطفاً ابتدا کافه را انتخاب کنید","error");return}if(g.value===null||g.value===""||g.value<0){n("لطفاً تعداد کارتن را وارد کنید","error");return}await ae(a)}}function te(a){let e=null;try{e=JSON.parse(a),console.log("Parsed as JSON:",e)}catch{console.log("Trying pipe-delimited format...");const s=a.split("|");s.length>=7&&(e={product:s[0]||"",blend:s[1]||"",origin:s[2]||"",roastDate:s[3]||"",batchNumber:s[4]||"",packageWeight:s[5]||"",packageAmount:parseInt(s[6])||0},console.log("Parsed pipe-delimited data:",e))}return e}async function ae(a){try{m.value=!0,n("در حال ثبت خروج...","info");const e=te(a);if(!e){n("فرمت QR نامعتبر است","error");return}e.cartonCount=Number(g.value),e.offset=x.value,e.packageAmount=parseInt(e.packageAmount)||0;const s=["product","blend","origin","roastDate","batchNumber","packageWeight","packageAmount"].filter(le=>!e[le]);if(s.length>0){n(`فیلدهای ضروری خالی: ${s.join(", ")}`,"error");return}const b=e.cartonCount*e.packageAmount+(e.offset||0),oe=await fetch("/api/sheets/outbound",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sheetName:d.value,isAdmin:!0,data:{Product:e.product,Blend:e.blend,Origin:e.origin,"Roast-Date":e.roastDate,"Batch-Number":e.batchNumber,"Package-Weight":e.packageWeight,"Package-Amount":e.packageAmount,cartoncount:e.cartonCount,offset:e.offset||0,"total-in-stock":b,Timestamp:new Date().toISOString()}})}),R=new Date().toLocaleTimeString("fa-IR",{hour:"2-digit",minute:"2-digit"});oe.ok?(p.value={cafe:d.value,data:e,totalDelivered:b,time:R},w.value.unshift({cafe:d.value,product:e.product,blend:e.blend,amount:b,time:R}),O(),h.value="",g.value=null,x.value=0,n(`✅ خروج ${b} عدد ${e.product} برای ${d.value} ثبت شد`,"success")):(p.value={cafe:d.value,data:e,totalDelivered:b,time:R},w.value.unshift({cafe:d.value,product:e.product,blend:e.blend,amount:b,time:R}),O(),h.value="",g.value=null,x.value=0,n(`خروج برای ${d.value} ثبت شد (آفلاین)`,"info"))}catch(e){console.error("خطا در پردازش:",e),n(`خطا در پردازش: ${e.message}`,"error")}finally{m.value=!1}}function n(a,e){D.value={text:a,type:e},setTimeout(()=>{D.value=null},3e3)}function O(){{const a=new Date().toDateString();localStorage.setItem(`outbound_${a}`,JSON.stringify(w.value))}}function se(){{const a=new Date().toDateString(),e=localStorage.getItem(`outbound_${a}`);if(e)try{w.value=JSON.parse(e)}catch(r){console.error("Error loading summary:",r)}}}return(a,e)=>{const r=fe;return l(),o("div",he,[t("div",be,[e[37]||(e[37]=W('<div class="header" data-v-6f864f66><div class="icon-container" data-v-6f864f66><svg viewBox="0 0 24 24" fill="none" data-v-6f864f66><rect x="1" y="3" width="15" height="13" stroke="currentColor" stroke-width="1.5" data-v-6f864f66></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8" stroke="currentColor" stroke-width="1.5" fill="currentColor" opacity="0.1" data-v-6f864f66></polygon><circle cx="5.5" cy="18.5" r="2.5" stroke="currentColor" stroke-width="1.5" data-v-6f864f66></circle><circle cx="18.5" cy="18.5" r="2.5" stroke="currentColor" stroke-width="1.5" data-v-6f864f66></circle></svg></div><h1 data-v-6f864f66>خروج کالا از انبار</h1><p class="subtitle" data-v-6f864f66>ثبت خروج و تحویل به مشتریان</p></div>',1)),N.value?(l(),o("div",ye,[e[5]||(e[5]=t("h4",null,"Debug Info:",-1)),t("pre",null,i(JSON.stringify(N.value,null,2)),1)])):v("",!0),C.value?(l(),o("div",we,e[6]||(e[6]=[t("span",{class:"spinner"},null,-1),t("p",null,"در حال بارگذاری لیست کافه‌ها...",-1)]))):v("",!0),M(q,{name:"fade"},{default:Q(()=>[D.value?(l(),o("div",{key:0,class:pe(["message",`message-${D.value.type}`])},i(D.value.text),3)):v("",!0)]),_:1}),C.value?v("",!0):(l(),o("div",ke,[e[10]||(e[10]=t("label",{class:"label"},"انتخاب کافه/مشتری",-1)),t("div",_e,[I(t("select",{"onUpdate:modelValue":e[0]||(e[0]=s=>d.value=s),class:"select-field",disabled:K.value||m.value},[e[7]||(e[7]=t("option",{value:""},"-- انتخاب کنید --",-1)),(l(!0),o(H,null,F(c.value,s=>(l(),o("option",{key:s.id,value:s.name},i(s.name),9,Se))),128))],8,Ce),[[L,d.value]]),e[8]||(e[8]=t("div",{class:"select-icon"},[t("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[t("path",{d:"M6 9l6 6 6-6"})])],-1))]),t("button",{onClick:z,class:"btn-refresh",disabled:C.value},e[9]||(e[9]=[t("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[t("path",{d:"M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0118.8-4.3m2 5.3a10 10 0 01-18.8 4.2"})],-1),S(" بازخوانی لیست ",-1)]),8,xe),c.value.length>0?(l(),o("div",De," تعداد کافه‌ها: "+i(c.value.length),1)):v("",!0)])),d.value?(l(),o("div",Ne,[y.value?(l(),o("button",{key:0,onClick:ee,disabled:f.value||m.value,class:"btn btn-primary btn-camera"},[e[13]||(e[13]=t("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[t("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2"}),t("circle",{cx:"12",cy:"12",r:"3"})],-1)),!f.value&&!m.value?(l(),o("span",Ie,"اسکن QR محصول")):f.value?(l(),o("span",Te,e[11]||(e[11]=[t("span",{class:"spinner"},null,-1),S(" در حال اسکن... ",-1)]))):(l(),o("span",Pe,e[12]||(e[12]=[t("span",{class:"spinner"},null,-1),S(" در حال ذخیره... ",-1)])))],8,Ae)):v("",!0),I(t("div",Re,null,512),[[ue,!_.value&&k.value]]),!_.value&&k.value?(l(),o("button",{key:1,onClick:e[1]||(e[1]=s=>P()),class:"btn btn-outline",style:{"margin-bottom":"20px"}},e[14]||(e[14]=[t("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[t("rect",{x:"4",y:"4",width:"16",height:"16"})],-1),S(" توقف اسکن ",-1)]))):v("",!0),y.value?(l(),o("div",Me,e[15]||(e[15]=[t("span",null,"یا",-1)]))):v("",!0),t("div",Qe,[e[16]||(e[16]=t("label",{for:"qrcode",class:"label"},"ورود دستی QR Data",-1)),t("div",Be,[I(t("textarea",{id:"qrcode","onUpdate:modelValue":e[2]||(e[2]=s=>h.value=s),placeholder:"فرمت Pipe: arabica|40-40-50|bra-col-eth|2025-10-08|25081110001|1 kg|6",onKeyup:de(ce($,["ctrl"]),["enter"]),disabled:m.value,class:"input-field",rows:"3"},null,40,Ee),[[J,h.value]])]),e[17]||(e[17]=t("small",{class:"input-hint"},"فرمت: product|blend|origin|roastDate|batchNumber|packageWeight|packageAmount",-1))]),t("div",$e,[e[18]||(e[18]=t("label",{for:"cartonCount",class:"label"},"تعداد کارتن",-1)),t("div",Oe,[I(t("input",{id:"cartonCount","onUpdate:modelValue":e[3]||(e[3]=s=>g.value=s),type:"number",min:"0",placeholder:"مثال: 5",disabled:m.value,class:"input-field number-input"},null,8,Ve),[[J,g.value,void 0,{number:!0}]])]),e[19]||(e[19]=t("small",{class:"input-hint"},"تعداد کارتن برای تحویل",-1))]),t("div",We,[e[22]||(e[22]=t("label",{for:"offset",class:"label"},"تعداد آفست",-1)),t("div",qe,[I(t("select",{id:"offset","onUpdate:modelValue":e[4]||(e[4]=s=>x.value=s),class:"select-field",disabled:m.value},e[20]||(e[20]=[t("option",{value:0},"بدون آفست",-1),t("option",{value:1},"1 عدد",-1),t("option",{value:2},"2 عدد",-1),t("option",{value:3},"3 عدد",-1),t("option",{value:4},"4 عدد",-1),t("option",{value:5},"5 عدد",-1)]),8,Le),[[L,x.value]]),e[21]||(e[21]=t("div",{class:"select-icon"},[t("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[t("path",{d:"M6 9l6 6 6-6"})])],-1))])]),t("button",{onClick:$,disabled:!h.value||m.value||g.value===null||g.value==="",class:"btn btn-primary"},[m.value?(l(),o("span",Je,e[23]||(e[23]=[t("span",{class:"spinner"},null,-1),S(" در حال ذخیره... ",-1)]))):(l(),o("span",Fe,"ثبت خروج"))],8,He)])):C.value?v("",!0):(l(),o("div",Ue,[e[24]||(e[24]=W('<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" data-v-6f864f66><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" data-v-6f864f66></path><circle cx="9" cy="7" r="4" data-v-6f864f66></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87" data-v-6f864f66></path><path d="M16 3.13a4 4 0 0 1 0 7.75" data-v-6f864f66></path></svg><p data-v-6f864f66>لطفاً ابتدا کافه مورد نظر را انتخاب کنید</p>',2)),c.value.length===0?(l(),o("p",je," هیچ کافه‌ای یافت نشد. لطفاً اتصال به Google Sheets را بررسی کنید. ")):v("",!0)])),M(q,{name:"slide"},{default:Q(()=>[p.value?(l(),o("div",Ke,[t("div",ze,[e[25]||(e[25]=t("span",{class:"result-label"},"آخرین ثبت",-1)),t("span",Ge,i(p.value.cafe),1)]),t("div",Xe,[t("div",Ye,[e[26]||(e[26]=t("span",{class:"item-label"},"محصول:",-1)),t("span",Ze,i(p.value.data.product),1)]),t("div",et,[e[27]||(e[27]=t("span",{class:"item-label"},"ترکیب:",-1)),t("span",tt,i(p.value.data.blend),1)]),t("div",at,[e[28]||(e[28]=t("span",{class:"item-label"},"منشأ:",-1)),t("span",st,i(p.value.data.origin),1)]),t("div",ot,[e[29]||(e[29]=t("span",{class:"item-label"},"تاریخ رست:",-1)),t("span",lt,i(p.value.data.roastDate),1)]),t("div",nt,[e[30]||(e[30]=t("span",{class:"item-label"},"شماره بچ:",-1)),t("span",rt,i(p.value.data.batchNumber),1)]),t("div",it,[e[31]||(e[31]=t("span",{class:"item-label"},"وزن:",-1)),t("span",ut,i(p.value.data.packageWeight),1)]),t("div",dt,[e[32]||(e[32]=t("span",{class:"item-label"},"تعداد کل:",-1)),t("span",ct,i(p.value.totalDelivered),1)])])])):v("",!0)]),_:1}),w.value.length>0?(l(),o("div",vt,[t("div",pt,[e[33]||(e[33]=t("span",{class:"section-title"},"خروجی‌های امروز",-1)),t("span",ft,i(w.value.length)+" مورد",1)]),t("div",mt,[(l(!0),o(H,null,F(w.value,(s,b)=>(l(),o("div",{key:b,class:"summary-item"},[t("div",gt,i(s.cafe),1),t("div",ht,[t("span",null,i(s.product)+" - "+i(s.blend),1),e[34]||(e[34]=t("span",{class:"dot"},"•",-1)),t("span",null,i(s.amount)+" عدد",1),e[35]||(e[35]=t("span",{class:"dot"},"•",-1)),t("span",null,i(s.time),1)])]))),128))])])):v("",!0),t("div",bt,[M(r,{to:"/admin/admin-index",class:"btn btn-outline"},{default:Q(()=>e[36]||(e[36]=[t("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[t("path",{d:"M15 18l-6-6 6-6"})],-1),S(" بازگشت به داشبورد ",-1)])),_:1,__:[36]})])])])}}},Dt=ne(yt,[["__scopeId","data-v-6f864f66"]]);export{Dt as default};
